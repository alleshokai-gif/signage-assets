<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signage Portal</title>
  <style>
    :root{
      --menu-h: 150px;            /* ã‚¢ã‚¤ã‚³ãƒ³ã§ã‹ã‚ */
      --menu-gap: 22px;
      --menu-pad: 18px;
      --menu-radius: 26px;
      --menu-bg: rgba(0,0,0,.22);
      --menu-border: rgba(255,255,255,.20);

      --icon-size: 108px;         /* â† ã“ã“ã§å¤§ãã•èª¿æ•´ */
      --icon-ring: rgba(255,255,255,.35);
      --icon-ring-active: rgba(255,255,255,.75);

      --shadow: 0 10px 24px rgba(0,0,0,.45);
    }

    html, body { height:100%; margin:0; background:#000; overflow:hidden; }

    /* iframeã¯å…¨ç”»é¢å›ºå®šï¼ˆLookerã¯å¸¸ã«ãƒ•ãƒ«ï¼‰ */
    .view {
      position:absolute; inset:0;
      width:100vw; height:100vh;
      border:0;
      opacity:0;
      pointer-events:none;
      transition: opacity 180ms linear;
      background:#000;
    }
    .view.active { opacity:1; pointer-events:auto; }

    #topMask{
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 6px;          /* ã¾ãš6pxã§ã€‚æ¶ˆãˆãŸã‚‰3pxã«ä¸‹ã’ã‚‹ */
      background: #000;
      z-index: 9999;
      pointer-events: none;
    }

    .rtClock{
      position: fixed;
      top: 18px;
      left: 0; right: 0;
      display: none;
      z-index: 80;
      pointer-events: none;
      text-align: center;
      color: rgba(255,255,255,.92);
      text-shadow: 0 6px 18px rgba(0,0,0,.55);
      letter-spacing: .04em;
      white-space: nowrap;
    }

    /* æ—¥ä»˜ï¼š1.5å€ */
    .rtDate{
      font-size: 84px;      /* â†ã“ã“ãŒæ—¥ä»˜ã‚µã‚¤ã‚º */
      font-weight: 500;
    }

    /* æ›œæ—¥ï¼šä»Šã®ã‚µã‚¤ã‚ºæ„Ÿã«åˆã‚ã›ã‚‹ï¼ˆå°ã•ã‚å›ºå®šï¼‰ */
    .rtDow{
      font-size: 56px;      /* â†ï¼ˆé‡‘ï¼‰ã®ã‚µã‚¤ã‚º */
      margin: 0 18px;
      font-weight: 500;
    }

    /* æ™‚åˆ»ï¼š1.5å€ */
    .rtTime{
      display: inline-flex;
      align-items: flex-start;
    }

    .rtHM{
      font-size: 84px;      /* â†ã“ã“ãŒæ™‚åˆ»(HH:MM)ã‚µã‚¤ã‚º */
      font-weight: 500;
    }

    /* ç§’ï¼šå³ä¸‹ã«å°ã•ã‚ */
    .rtSec{
      font-size: 42px;      /* â†æ™‚åˆ»ã®åŠåˆ†ãã‚‰ã„ */
      margin-left: 10px;
      margin-top: 34px;     /* â†ä¸‹ã’å…·åˆï¼ˆå¥½ã¿ã§å¾®èª¿æ•´ï¼‰ */
      opacity: .92;
      letter-spacing: .06em;
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼šä¸‹ã«é‡ã­ã‚‹ï¼ˆç”»é¢åˆ†å‰²ã—ãªã„ï¼‰ */
    #menuWrap {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: var(--menu-h);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 50;
      pointer-events: auto;   /* âœ… ã“ã‚Œã«ã™ã‚‹ */
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ï¼ˆåŠé€æ˜ã®å°åº§ï¼‰ */
    #menu{
      pointer-events: auto;
      display:flex;
      gap: var(--menu-gap);
      padding: 0;                 /* å°åº§ã„ã‚‰ã‚“ */
      background: transparent;    /* é€æ˜ */
      border: 0;                  /* æ ãªã— */
      border-radius: 0;
      box-shadow: none;           /* å½±ãªã— */
      backdrop-filter: none;      /* ã¼ã‹ã—ãªã— */
    }

    /* ãƒœã‚¿ãƒ³ï¼ˆãƒ•ã‚¡ãƒ³ã‚·ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æƒ³å®šï¼‰ */
    .mBtn{
      pointer-events: auto;       /* â†ã“ã“ã ã‘ã‚¯ãƒªãƒƒã‚¯æœ‰åŠ¹ */
      width: var(--icon-size);
      height: var(--icon-size);
      border: 0;
      padding: 0;
      border-radius: 999px;
      background: transparent;
      cursor: pointer;
      position: relative;
      outline: none;
      -webkit-tap-highlight-color: transparent;
      transform: translateZ(0);
    }

    /* ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒï¼ˆPNG/WebP/SVGï¼‰ */
    .mBtn img{
      width: 100%;
      height: 100%;
      display:block;
      border-radius: 999px;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    /* è¼ªã£ã‹ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ï¼‰ */
    .mBtn::after{
      content:'';
      position:absolute; inset:-6px;
      border-radius:999px;
      border: 3px solid var(--icon-ring);
      opacity: .9;
      transition: 140ms;
    }
    .mBtn.active::after{
      border-color: var(--icon-ring-active);
      box-shadow: 0 0 0 6px rgba(255,255,255,.10);
    }

    /* æŠ¼ã—ãŸã¨ãã®æ°—æŒã¡ã‚ˆã• */
    .mBtn:active { transform: scale(0.96); }

    /* å·¦ä¸Šãƒ‡ãƒãƒƒã‚°ï¼ˆä»»æ„ï¼‰ */
    #toast{
      position: fixed;
      left: 10px; top: 10px;
      z-index: 60;
      font-size: 12px;
      color: rgba(255,255,255,.85);
      background: transparent;  /* â† é»’ç®±æ¶ˆã™ */
      border: 0;                /* â† æ æ¶ˆã™ */
      padding: 0;               /* â† ä½™ç™½æ¶ˆã™ */
      border-radius: 0;
      pointer-events:none;
    }
    .subModal{
      position:fixed; inset:0;
      display:none;
      z-index: 200;
      background: rgba(0,0,0,.55);
      align-items:center;
      justify-content:center;
    }
    .subModal.show{ display:flex; }
    
    .subPanel{
      width: min(920px, 92vw);
      border-radius: 28px;
      background: rgba(15,15,15,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.10);
      padding: 18px 18px 22px;
    }
    
    .subHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
    }
    .subTitle{
      font-size: 34px;
      font-weight: 600;
      color: rgba(255,255,255,.92);
      letter-spacing:.04em;
    }
    .subClose{
      width:64px; height:64px;
      border-radius: 18px;
      border: 0;
      font-size: 44px;
      line-height: 1;
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
    }
    
    /* ===== å­ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼šã‚¿ã‚¤ãƒ«ï¼ˆã‚¢ãƒ—ãƒªä¸€è¦§ï¼‰ ===== */
    .subGrid{
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* 3åˆ—ãŒä¸€ç•ªOSã£ã½ã„ */
      gap: 26px;
    }
    
    /* ã‚¿ã‚¤ãƒ«æœ¬ä½“ï¼šæ­£æ–¹å½¢å›ºå®š */
    .subItem{
      aspect-ratio: 1 / 1;
      width: 100%;
      border: 0;
      border-radius: 28px;
    
      background: rgba(255,255,255,.10);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transform: translateZ(0);
    }
    
    /* æŠ¼ã—ãŸã¨ã */
    .subItem:active{
      transform: scale(0.97);
      background: rgba(255,255,255,.15);
    }
    
    /* ã‚¢ã‚¤ã‚³ãƒ³ï¼šã‚¿ã‚¤ãƒ«ã®ä¸»å½¹ */
    .subIconImg{
      width: 65%;
      height: 65%;
      border-radius: 22px;
      object-fit: cover;
      display: block;
    }
    
    /* ãƒ©ãƒ™ãƒ«ï¼šçŸ­ãå¤ªã */
    .subLabel{
      font-size: 20px;
      font-weight: 700;
      line-height: 1.1;
      text-align: center;
      color: rgba(255,255,255,.95);
      text-shadow: 0 6px 18px rgba(0,0,0,.35);
    }
    
    .subIcon{
      font-size: 44px;
    }

    .subItem:active{ transform: scale(0.98); }
    .subItem:active .subIconWrap{
      background: rgba(255,255,255,.22);
      transform: scale(0.97);
    }
    
    /* ç”»é¢ãŒå°ã•ã„ã¨ãã¯è‡ªå‹•ã§ç¸®ã‚ã‚‹ï¼ˆä¿é™ºï¼‰ */
    @media (max-width: 900px){
      :root{ --icon-size: 92px; --menu-h: 135px; --menu-gap: 16px; }
    }
    @media (max-width: 720px){
      :root{ --icon-size: 82px; --menu-h: 125px; --menu-gap: 12px; }
    }
  </style>
</head>
<body>
  <div id="topMask"></div>

  <div id="rtClock" class="rtClock">
    <span id="rtDate" class="rtDate"></span>
    <span id="rtDow"  class="rtDow"></span>
    <span id="rtTime" class="rtTime">
      <span id="rtHM" class="rtHM"></span>
      <span id="rtSec" class="rtSec"></span>
    </span>
  </div>

  <iframe id="view" class="view active" src="about:blank"></iframe>


  <!-- ãƒ‡ãƒãƒƒã‚° -->
  <div id="toast">boot...</div>

  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆä¸‹éƒ¨ã«é‡ã­ï¼‰ -->
  <div id="menuWrap">
    <div id="menu" aria-label="menu">
      <button class="mBtn" data-page="home"   aria-label="home">
        <img src="https://alleshokai-gif.github.io/signage-assets/assets/icons/ICON_HOME.png" alt="home">
      </button>
      <button class="mBtn" data-page="finance" aria-label="finance">
        <img src="https://alleshokai-gif.github.io/signage-assets/assets/icons/ICON_FINANCE.png" alt="finance">
      </button>
      <button class="mBtn" data-page="schedule" aria-label="schedule">
        <img src="https://alleshokai-gif.github.io/signage-assets/assets/icons/ICON_SCHEDULE.png" alt="schedule">
      </button>
      <button class="mBtn" data-page="temp" aria-label="temp">
        <img src="https://alleshokai-gif.github.io/signage-assets/assets/icons/ICON_TEMP.png" alt="temp">
      </button>
      <button class="mBtn" data-page="school" aria-label="school">
        <img src="https://alleshokai-gif.github.io/signage-assets/assets/icons/ICON_SCHOOL.png" alt="school">
      </button>
      <button class="mBtn" data-page="game"  aria-label="game">
        <img src="https://alleshokai-gif.github.io/signage-assets/assets/icons/ICON_GAME.png" alt="game">
      </button>
    </div>
  </div>
  <!-- å­ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
  <div id="subModal" class="subModal" aria-hidden="true">
    <div class="subPanel">
      <div class="subHead">
        <div id="subTitle" class="subTitle">MENU</div>
        <button id="subClose" class="subClose" aria-label="close">Ã—</button>
      </div>
      <div id="subGrid" class="subGrid"></div>
    </div>
  </div>
  
<script>
(() => {

  try {
    // ====== å…„å¼Ÿï¼šã“ã“ã ã‘å·®ã—æ›¿ãˆãŸã‚‰OK ======
    // â€» Lookerã®ã€ŒåŸ‹ã‚è¾¼ã¿URLã€æ¨å¥¨ï¼ˆ/embed/reporting/...ï¼‰
    const PAGES = {
      home:    { url: 'https://lookerstudio.google.com/embed/reporting/c3341ade-526b-4ef1-8f77-e04e885ccf81/page/p_7ie80j9qzd', auto:true },
      temp:    { url: 'https://lookerstudio.google.com/embed/reporting/a9247f37-fc30-425b-a648-1c360e725914/page/p_2o3y60glyd', auto:true },
      school:  { url: 'https://lookerstudio.google.com/embed/reporting/e56ad71b-8c4c-4a59-88fa-99e773c8809a/page/p_20w8aknpyd', auto:true },
      finance: { url: 'https://lookerstudio.google.com/embed/reporting/27c09c89-3b08-46f8-bc49-db0d6e60c3fe/page/p_kbyrml84yd', auto:true },
      schedule:{ url: 'https://alleshokai-gif.github.io/signage-assets/schedule', auto:true }, // â˜…ã“ã“
      game:    { url: 'https://alleshokai-gif.github.io/signage-assets/games/hissan', auto:false },
    };

    // â˜… GAS Webã‚¢ãƒ—ãƒªï¼ˆJSON APIï¼‰ã®URLï¼ˆã‚ã¨ã§å…¥ã‚Œã‚‹ï¼‰
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxImsH4sWBlEbYaiEl4X7mUmAsuzr3j8hRJeg7Hlq6fXSQRh79XCGB8PoX7arfbPrnbXQ/exec';
    const AUTO_ORDER = Object.keys(PAGES).filter(k => PAGES[k].auto);
    const AUTO_SEC = 60;              // è‡ªå‹•å·¡å› ç§’
    const IDLE_HOME_SEC = 300;        // æ”¾ç½®ã§ãƒ›ãƒ¼ãƒ å¾©å¸°ï¼ˆä»»æ„ï¼‰
    const IDLE_FINANCE_SEC = 180;      // å®¶è¨ˆã¯çŸ­ã‚ï¼ˆä»»æ„ï¼‰
    const IDLE_GAME_SEC = 300;        // ã‚²ãƒ¼ãƒ ã¯é•·ã‚ï¼ˆä»»æ„ï¼‰
    const BOOT_HOLD_SEC = 120;     // èµ·å‹•ç›´å¾Œã ã‘é•·ã‚ã«è¦‹ã›ã‚‹
    const DEBUG = false;
    const VOICE_BASE =  'https://alleshokai-gif.github.io/signage-assets/assets/voice/';

    // ====== DOM ======
    const view = document.getElementById('view');
    const toast = document.getElementById('toast');
    const menu = document.getElementById('menu');


    const rtClock = document.getElementById('rtClock');

    const rtDate = document.getElementById('rtDate');
    const rtDow  = document.getElementById('rtDow');
    const rtHM   = document.getElementById('rtHM');
    const rtSec  = document.getElementById('rtSec');

    function pad2(n){ return String(n).padStart(2,'0'); }
    const DOW = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

    function updateRtClock(){
      const d = new Date();
      rtDate.textContent = `${d.getMonth()+1}/${d.getDate()}`;
      rtDow.textContent  = `ï¼ˆ${DOW[d.getDay()]}ï¼‰`;
      rtHM.textContent   = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      rtSec.textContent  = pad2(d.getSeconds()); // â†ã€Œ:ã€ãªã—ã§å³ä¸‹ã«å‡ºã™
    }

    setInterval(updateRtClock, 250); // 1ç§’ã§ã‚‚OKã€‚ã¬ã‚‹ã¬ã‚‹ã—ãŸã„ãªã‚‰250ms
    updateRtClock();

    toast.textContent = '';   // â† ã“ã‚Œè¿½åŠ 
    // ====== state ======
    let currentPage = null;
    let navToken = 0;

    let autoTimer = null;
    let autoIndex = 0;
    let autoEnabled = true;

    let idleTimer = null;

    // ===== TTS (Zundamon) =====
    let _playing = false;

    async function playQueue(keys){
      if (_playing) return;
      _playing = true;
      try{
        for (const k of keys) await playOne(k);
      } finally {
        _playing = false;
      }
    }

    function playOne(key){
      return new Promise(resolve => {
        const a = new Audio(VOICE_BASE + key + '.wav');
        a.onended = resolve;
        a.onerror = resolve;
        a.play().catch(resolve);
      });
    }

    async function requestVoiceQueue(reason){
      try{
        setToast('VOICE REQ... (' + reason + ')');
    
        if (!GAS_API_URL || GAS_API_URL.includes('PASTE')) {
          setToast('VOICE STOP: GAS_API_URL not set');
          console.log('GAS_API_URL not set');
          return;
        }
    
        const url = GAS_API_URL + '?reason=' + encodeURIComponent(reason || '');
        console.log('requestVoiceQueue fetch', url);
    
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
    
        const res = await r.json();
        console.log('getVoiceQueueForNow success', res);
    
        const voices = (res && res.voices) ? res.voices : [];
        setToast('VOICE OK: ' + (voices.join(', ') || 'none'));
    
        if (!voices.length) return;
        await playQueue(voices);
    
      }catch(err){
        setToast('VOICE FAIL');
        console.log('getVoiceQueueForNow FAILED', err);
      }
    }

    // ===== TTS (Web Speech API) =====
    let _voice = null;

    function setToast(msg){
      if (!DEBUG) return;
      toast.textContent = msg;
    }

    function setMenuActive(page){
      [...menu.querySelectorAll('.mBtn')].forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === page);
      });
    }

    // æ”¾ç½®å¾©å¸°
    function resetIdleTimer(){
      if (idleTimer) clearTimeout(idleTimer);

      const sec =
        (currentPage === 'finance') ? IDLE_FINANCE_SEC :
        (currentPage === 'game')    ? IDLE_GAME_SEC :
                                    IDLE_HOME_SEC;

      if (!sec || sec <= 0) return;

      idleTimer = setTimeout(() => {
        // ã„ããªã‚Šæˆ»ã™ã¨æ³£ãã‹ã‚‰ã€ã¾ãšãƒ›ãƒ¼ãƒ ã¸
        goHome({ reason:'idle' });
      }, sec * 1000);
    }
    ['click','touchstart','mousemove','keydown'].forEach(ev=>{
      window.addEventListener(ev, resetIdleTimer, { passive:true });
    });

    // ====== navigation (preload swap) ======
    function navigate(page, { reason='manual' } = {}) {
      if (!PAGES[page]) return;
      if (reason === 'manual') stopAuto();

      const url = PAGES[page].url;

      setToast(`loading: ${page} (${reason})`);
      setMenuActive(page);

      // å‰ã®onloadã‚’å¤–ã™ï¼ˆãƒ¬ãƒ¼ã‚¹é˜²æ­¢ï¼‰
      view.onload = null;

      // ã“ã®é·ç§»ã ã‘æœ‰åŠ¹ã«ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³
      const myToken = ++navToken;

      // âœ… ã“ã®é·ç§»ã§ã€Œshownç¢ºå®šã€ã¯1å›ã ã‘ã«ã™ã‚‹
      let settled = false;
      const settleShown = (via) => {
        if (settled) return;
        if (myToken !== navToken) return;
        settled = true;

        currentPage = page;
        setToast(`shown${via}: ${page}`);
        resetIdleTimer();

        rtClock.style.display = (page === 'home') ? 'block' : 'none';

        // ====== ğŸ”Š ã“ã“ãŒãƒˆãƒªã‚¬ãƒ¼ï¼šhomeè¡¨ç¤ºç¢ºå®šã§é³´ã‚‰ã™ ======
        if (page === 'home') {
          const allow = (reason === 'manual' || reason === 'boot');

          console.log('VOICE TRIGGER check', { page, reason, allow });
          if (allow) {
            setToast('VOICE TRIGGER');
            requestVoiceQueue(reason);
          }
        }
      };

      // onloadæ¥ãªã„ä¿é™º
      const FALLBACK_MS = 2500;
      const fb = setTimeout(() => settleShown('*'), FALLBACK_MS);

      // onloadæ¥ãŸã‚‰å³ç¢ºå®š
      view.onload = () => {
        clearTimeout(fb);
        settleShown('');
      };

      // é·ç§»
      view.src = url;
    }
    
    function navigateUrl(url, parentKey, { reason='manual' } = {}){
      if (reason === 'manual') stopAuto();
    
      // é·ç§»é–‹å§‹ã§æ™‚è¨ˆã¯æ¶ˆã™ï¼ˆhomeä»¥å¤–ï¼‰
      rtClock.style.display = 'none';
    
      setMenuActive(parentKey);
    
      view.onload = null;
      const myToken = ++navToken;
    
      let settled = false;
      const settle = () => {
        if (settled) return;
        if (myToken !== navToken) return;
        settled = true;
    
        currentPage = parentKey;
        resetIdleTimer();
      };
    
      const fb = setTimeout(settle, 2500);
      view.onload = () => { clearTimeout(fb); settle(); };
    
      view.src = url;
    }

    // ====== auto rotate ======
    function startAuto(){
      if (autoTimer) return;
      autoEnabled = true;

      // autoå¯¾è±¡ã®ã©ã‚Œã‹ã‚’è¡¨ç¤ºã—ã¦ãªã„ãªã‚‰å…ˆé ­ã¸
      const first = AUTO_ORDER[0];
      if (!currentPage || !PAGES[currentPage].auto) {
        autoIndex = 0;
        navigate(first, { reason:'auto' });
      } else {
        autoIndex = AUTO_ORDER.indexOf(currentPage);
        if (autoIndex < 0) autoIndex = 0;
      }

      const firstDelay = BOOT_HOLD_SEC * 1000;

      autoTimer = setTimeout(() => {
        autoTimer = setInterval(() => {
          if (!autoEnabled) return;
          autoIndex = (autoIndex + 1) % AUTO_ORDER.length;
          navigate(AUTO_ORDER[autoIndex], { reason:'auto' });
        }, AUTO_SEC * 1000);
      }, firstDelay);

    }

    function stopAuto(){
      autoEnabled = false;
      if (autoTimer) {
        clearTimeout(autoTimer);
        clearInterval(autoTimer);
      }
      autoTimer = null;
    }

    function goHome({reason='manual'} = {}){
      navigate('home', { reason });
      startAuto(); // ãƒ›ãƒ¼ãƒ ã¯è‡ªå‹•å·¡å›å¾©å¸°ã‚¹ã‚¤ãƒƒãƒ
    }

    // ====== menu events ======
    window.addEventListener('pointerdown', sfxUnlock, { once:true });

    let _lastTap = 0;

    function onMenu(e){
      // é€£æ‰“/äºŒé‡ã‚¤ãƒ™ãƒ³ãƒˆæŠ‘æ­¢ï¼ˆ350msä»¥å†…ã¯æ¨ã¦ã‚‹ï¼‰
      const t = Date.now();
      if (t - _lastTap < 350) return;
      _lastTap = t;

      e.preventDefault(); // ä½™è¨ˆãªclickç”Ÿæˆã‚’æŠ‘ãˆã‚‹ç«¯æœ«ãŒã‚ã‚‹
      sfxUnlock();
      sfxMenu();

      const btn = e.target.closest('.mBtn');
      if (!btn) return;
      const page = btn.dataset.page;

      if (page === 'test') {
        // âœ… ã“ã‚ŒãŒæœ€å¼·ï¼šç¢ºå®Ÿã«é³´ã‚‹
        playQueue(['MORNING_SUMMARY']); // ä½•ã§ã‚‚ãˆãˆ
        // ã‚‚ã—ãã¯ GAS å‘¼ã³å‡ºã—ç¢ºèªã—ãŸã„ãªã‚‰ï¼š
        // requestVoiceQueue('manual');
        return;
      }

      if (page === 'home') return goHome({reason:'manual'});
      
      // â˜… school/game/finance ã¯å­ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
      if (SUB[page]) return openSubMenu(page);
      
      navigate(page, { reason:'manual' });

    }

    menu.addEventListener('pointerdown', onMenu);

    // --- å­ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®šç¾©ï¼ˆã¾ãšã¯ã“ã“ã ã‘ã§OKï¼‰ ---
    const SUB = {
      school: [
        { label:'çµ¦é£Ÿ/äºˆå®š',  iconImg:'ICON_schoolTOP.png', page:'school' },      // æ—¢å­˜PAGES.school
        { label:'å­¦ç´šé–‰é–', iconImg:'ICON_shoolclose.png', url:'https://lookerstudio.google.com/embed/reporting/543880b2-7b47-4237-8f34-a38f5a8da822/page/p_o5u8y9pt0d' },
        { label:'é–‰é–ãƒãƒƒãƒ—', iconImg:'ICON_schoolcloseMAP.png', url:'https://lookerstudio.google.com/embed/reporting/ac202568-eb4b-409a-8436-2766b21221ad/page/p_un4ijj2v0d' },
      ],
      game: [
        { label:'ä¹ä¹', iconImg:'ICON_gameKUKU.png',  url:'https://alleshokai-gif.github.io/kuku-game/' },
        { label:'ç­†ç®—', iconImg:'ICON_gameHS.png',  page:'game' },            // æ—¢å­˜PAGES.game(ç­†ç®—)
        { label:'ã‚ªã‚»ãƒ­', iconImg:'ICON_gamesOTHERO.png',  url:'https://alleshokai-gif.github.io/signage-assets/games/othello/' },
        { label:'ãƒœãƒ³ãƒœãƒ³åˆ†æ', iconImg:'ICON_bonbon.png', url:'https://lookerstudio.google.com/embed/reporting/5e1dd718-4c59-4f7f-b380-9af4b919003e/page/p_fhnahkeo0d' },
      ],
      finance: [
        { label:'å®¶è¨ˆãƒ€ãƒƒã‚·ãƒ¥', iconImg:'ICON_financeTOP.png', page:'finance' },  // æ—¢å­˜PAGES.finance
        { label:'ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—çµŒè²»', iconImg:'ICON_financePIC.png', url:'https://lookerstudio.google.com/embed/reporting/9fb4191b-bed4-4c43-8609-2d54b25bddcb/page/p_sd2wt4noyd' },
        { label:'å…‰ç†±è²»', iconImg:'ICON_financeUTILITY.png', url:'https://lookerstudio.google.com/embed/reporting/fe2966db-7911-4345-9bb9-e7f20ce67f1e/page/p_kbyrml84yd' },
        { label:'ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ©ãƒ³ã‚¯', iconImg:'ICON_financeVR.png', url:'https://lookerstudio.google.com/embed/reporting/7aa1e911-8971-4724-aea3-731a3290eb97/page/p_vdxclf0zzd' },
        { label:'æ”¯å‡ºãƒ©ãƒ³ã‚¯', iconImg:'ICON_financeAmtR.png', url:'https://lookerstudio.google.com/embed/reporting/a9e7808d-828d-4c1f-8317-5adc3e44386f/page/p_4s4wd13m0d' },
      ],
    };
    const ICON_BASE = 'https://alleshokai-gif.github.io/signage-assets/assets/icons/';
    // --- å­ãƒ¡ãƒ‹ãƒ¥ãƒ¼DOM ---
    const subModal = document.getElementById('subModal');
    const subGrid  = document.getElementById('subGrid');
    const subTitle = document.getElementById('subTitle');
    const subClose = document.getElementById('subClose');
    
    function openSubMenu(parentKey){
      const items = SUB[parentKey];
      if (!items || !items.length) return;
    
      subTitle.textContent = parentKey.toUpperCase();
      subGrid.innerHTML = '';
    
      for (const it of items){
        const b = document.createElement('button');
        b.className = 'subItem';
      
        // ===== ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç”»åƒã‚’ç›´ã§é…ç½®ï¼‰ =====
        if (it.iconImg){
          const img = document.createElement('img');
          img.src = ICON_BASE + it.iconImg;
          img.className = 'subIconImg';
          b.appendChild(img);
        }
        
        // ===== ãƒ©ãƒ™ãƒ« =====
        const label = document.createElement('span');
        label.className = 'subLabel';
        label.textContent = it.label;
        
        b.appendChild(label);

        // ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆæ—¢å­˜ãã®ã¾ã¾ï¼‰
        b.addEventListener('pointerdown', (e)=>{
          e.preventDefault();
          sfxUnlock(); sfxMenu();
          stopAuto();                // â˜… ã“ã‚Œè¿½åŠ ï¼ˆã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ navigate é€šã‚‰ã‚“ã‹ã‚‰ï¼‰
          // ã¤ã„ã§ã«æ™‚è¨ˆã¯å³æ¶ˆã™ï¼ˆå¾Œè¿°ï¼‰
          rtClock.style.display = 'none';  // â˜… ã“ã‚Œã‚‚è¿½åŠ 
      
          if (it.page){
            navigate(it.page, { reason:'manual' });
          } else if (it.url){
            navigateUrl(it.url, parentKey, { reason:'manual' });
          }      
          closeSubMenu();
        });
      
        subGrid.appendChild(b);
      }

    
      subModal.classList.add('show');
      subModal.setAttribute('aria-hidden', 'false');
    }
    
    function closeSubMenu(){
      subModal.classList.remove('show');
      subModal.setAttribute('aria-hidden', 'true');
    }
    
    subClose.addEventListener('pointerdown', (e)=>{ e.preventDefault(); sfxMenu(); closeSubMenu(); });
    subModal.addEventListener('pointerdown', (e)=>{
      if (e.target === subModal) { sfxMenu(); closeSubMenu(); } // èƒŒæ™¯ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
    });



    
    // ====== boot ======
    currentPage = null;

    // â˜…C: èµ·å‹•ç›´å¾Œã¯å¿…ãš navigate çµŒç”±ã§ home ã‚’è¸ã‚€ï¼ˆsettleShown ã‚’ç¢ºå®Ÿã«é€šã™ï¼‰
    navigate('home', { reason: 'boot' });

    // ãã®å¾Œ auto é–‹å§‹ï¼ˆhome ã‚’èµ·ç‚¹ã«å›ã™ï¼‰
    startAuto();

    resetIdleTimer();

    const CLOCK_SPEAK_TIMES = ['06:55', '07:20', '07:40', '18:30', '21:00'];
    const CLOCK_KEY_PREFIX = 'clockSpoke_'; // äºŒé‡é˜²æ­¢

    function tickClockVoice(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const hm = `${hh}:${mm}`;

      if (!CLOCK_SPEAK_TIMES.includes(hm)) return;

      const day = now.toISOString().slice(0,10);
      const key = `${CLOCK_KEY_PREFIX}${day}_${hm}`;
      if (localStorage.getItem(key)) return;

      localStorage.setItem(key, '1');

      // â˜… 7:40ã ã‘å°‚ç”¨reasonã‚’æŠ•ã’ã‚‹
      if (hm === '07:40') {
        requestVoiceQueue('clock_0740');   // â†é€±æ˜ã‘ä¸Šå±¥ããƒ»ä½“æ“æœç”¨
      } else {
        requestVoiceQueue('clock');        // â†é€šå¸¸ã®æœãƒ»å¤œã‚¢ãƒŠã‚¦ãƒ³ã‚¹
      }
    }

    setInterval(tickClockVoice, 15 * 1000);

    // ===== SFX (Web Audio) =====
    let _ac = null;

    function sfxUnlock(){
      if (_ac) return;
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return;
      _ac = new AC();

      // unlockç”¨ã«ç„¡éŸ³ã‚’ä¸€ç¬é³´ã‚‰ã™ï¼ˆç«¯æœ«ã«ã‚ˆã£ã¦å¿…è¦ï¼‰
      const o = _ac.createOscillator();
      const g = _ac.createGain();
      g.gain.value = 0.0001;
      o.connect(g).connect(_ac.destination);
      o.start();
      o.stop(_ac.currentTime + 0.02);
    }

    function sfxTone(freq=440, ms=80, type='sine', vol=0.12){
      if (!_ac) return;
      const t0 = _ac.currentTime;
      const o = _ac.createOscillator();
      const g = _ac.createGain();

      o.type = type;
      o.frequency.setValueAtTime(freq, t0);

      // ã‚¯ãƒªãƒƒã‚¯éŸ³é˜²æ­¢ã®ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.linearRampToValueAtTime(vol, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);

      o.connect(g).connect(_ac.destination);
      o.start(t0);
      o.stop(t0 + ms/1000 + 0.02);
    }

    // ä½¿ã„ã‚„ã™ã„ãƒ—ãƒªã‚»ãƒƒãƒˆ
    function sfxMenu(){      sfxTone(880, 35, 'square', 0.06); }      // ãƒ”ãƒƒ
    function sfxCorrect(){   sfxTone(784, 60,'sine', 0.10); setTimeout(()=>sfxTone(1046, 80,'sine',0.12), 70); } // ãƒãƒ¼ãƒ³
    function sfxWrong(){     sfxTone(160,120,'sawtooth',0.14); setTimeout(()=>sfxTone(120,120,'sawtooth',0.14), 70); } // ãƒ–ãƒ¼

  } catch (e) {
    const t = document.getElementById('toast');
    if (t) t.textContent = 'ERR: ' + (e && e.message ? e.message : e);
    console.log(e);
  }

})();
</script>
</body>
</html>

